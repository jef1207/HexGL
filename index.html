<!doctype html>
<html lang="en">
  <head>
    <title>HexGL Racing</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="css/multi.css" type="text/css" charset="utf-8">
    <link rel="stylesheet" href="css/fonts.css" type="text/css" charset="utf-8">
    <style>
      body {
        padding:0;
        margin:0;
        overflow: hidden;
        touch-action: manipulation;
      }
      canvas { 
        pointer-events:none; 
        width: 100%;
        height: 100%;
      }
      #overlay{
        position: absolute;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
      
      /* Touch Controls */
      #touch-controls {
        position: absolute;
        bottom: 20px;
        width: 100%;
        display: flex;
        justify-content: space-between;
        z-index: 10000;
        padding: 0 15px;
        box-sizing: border-box;
      }
      .dpad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-gap: 5px;
      }
      .dpad button {
        width: 60px;
        height: 60px;
        font-size: 24px;
        background: rgba(0,0,0,0.5);
        color: white;
        border: 2px solid white;
        border-radius: 50%;
        touch-action: manipulation;
      }
      .actions {
        display: flex;
        align-items: center;
      }
      .actions button {
        width: 80px;
        height: 80px;
        font-size: 16px;
        background: rgba(255,50,50,0.7);
        color: white;
        border: 2px solid white;
        border-radius: 50%;
        touch-action: manipulation;
      }
      
      /* Telegram UI Adaptations */
      #tg-back-btn {
        position: absolute;
        top: 15px;
        left: 15px;
        z-index: 10001;
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        font-family: inherit;
      }
      #tg-share-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 10001;
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        font-family: inherit;
      }
    </style>
  </head>

  <body>
    <!-- Telegram Mini App Integration -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
      const tg = window.Telegram.WebApp;
      tg.expand();
      tg.enableClosingConfirmation();
      
      function shareScore() {
        const score = window.currentScore || 0;
        tg.sendData(JSON.stringify({ score: score }));
      }
      
      function goBack() {
        window.location.reload();
      }
    </script>

    <!-- Game Steps -->
    <div id="step-1">
      <div id="global"></div>
      <div id="title"></div>
      <div id="menucontainer">
        <div id="menu">
          <div id="start">Start</div>
          <div id="s-controlType">Controls: Touch</div>
          <div id="s-quality">Quality: Medium</div>
          <div id="s-hud">HUD: On</div>
          <div id="s-credits">Credits</div>
        </div>
      </div>
    </div>
    
    <div id="step-2" style="display: none">
      <div id="ctrl-help">Tap to continue</div>
    </div>
    
    <div id="step-3" style="display: none">
      <div id="progressbar"></div>
    </div>
    
    <div id="step-4" style="display: none">
      <button id="tg-back-btn">Menu</button>
      <button id="tg-share-btn">Share Score</button>
      
      <div id="overlay"></div>
      <div id="main"></div>
      
      <!-- Touch Controls -->
      <div id="touch-controls">
        <div class="dpad">
          <div></div>
          <button id="up">↑</button>
          <div></div>
          <button id="left">←</button>
          <div></div>
          <button id="right">→</button>
          <div></div>
          <button id="down">↓</button>
          <div></div>
        </div>
        <div class="actions">
          <button id="boost">BOOST</button>
        </div>
      </div>
    </div>
    
    <div id="step-5" style="display: none">
      <div id="time"></div>
      <div id="ctrl-help">Tap to continue</div>
    </div>
    
    <div id="credits" style="display: none">
      <h3>HexGL for Telegram</h3>
      <p>Adapted from BKcore's original</p>
      <h4>Tap anywhere to continue</h4>
    </div>

    <!-- Optimized Script Loading -->
    <script src="libs/Three.js"></script>
    <script src="libs/Detector.js"></script>
    
    <!-- Remove unused libraries -->
    <!-- 
    <script src="libs/leap-0.4.1.min.js"></script>
    <script src="libs/DAT.GUI.min.js"></script>
    <script src="libs/Stats.js"></script>
    -->
    
    <script src="bkcore.coffee/controllers/TouchController.js"></script>
    
    <!-- Core Game Scripts -->
    <script src="bkcore/Utils.js"></script>
    <script src="bkcore/threejs/RenderManager.js"></script>
    <script src="bkcore/hexgl/HUD.js"></script>
    <script src="bkcore/hexgl/RaceData.js"></script>
    <script src="bkcore/hexgl/ShipControls.js"></script>
    <script src="bkcore/hexgl/ShipEffects.js"></script>
    <script src="bkcore/hexgl/CameraChase.js"></script>
    <script src="bkcore/hexgl/Gameplay.js"></script>
    <script src="bkcore/hexgl/tracks/Cityscape.js"></script>
    <script src="bkcore/hexgl/HexGL.js"></script>

    <script>
      // Simplified launch.js with touch control integration
      document.addEventListener('DOMContentLoaded', () => {
        // Initialize touch controls
        const controls = {
          left: false,
          right: false,
          up: false,
          down: false,
          boost: false
        };
        
        function setupTouchControl(id) {
          const btn = document.getElementById(id);
          btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            controls[id] = true;
          });
          btn.addEventListener('touchend', () => {
            controls[id] = false;
          });
        }
        
        ['left', 'right', 'up', 'down', 'boost'].forEach(setupTouchControl);
        
        // Override keyboard controls with touch
        window.vehicleControl = {
          isLeft: () => controls.left,
          isRight: () => controls.right,
          isAccelerate: () => controls.up,
          isBrake: () => controls.down,
          isBoost: () => controls.boost
        };
        
        // Telegram button handlers
        document.getElementById('tg-share-btn').addEventListener('click', shareScore);
        document.getElementById('tg-back-btn').addEventListener('click', goBack);
        
        // Start game with touch as default
        setTimeout(() => {
          if(typeof HexGL !== 'undefined') {
            HexGL.init();
            HexGL.start();
          }
        }, 500);
      });
    </script>
  </body>
</html>
